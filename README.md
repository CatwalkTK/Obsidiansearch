# 社内ナレッジ可視化AI

AIを活用したWebインターフェースで、社内に蓄積されたナレッジを検索したり、チャットしたりすることができます。マークダウンファイルをアップロードし、蓄積された情報に基づいて質問をすることで、的確な答えを得ることができます。

## カスタマイズ内容

本アプリケーションは元のObsidian Vault AI検索から以下のようにカスタマイズされています：

### ブランディング変更
- **アプリケーション名**: 「Obsidian Vault AI検索」→「社内ナレッジ可視化AI」
- **コンセプト**: Obsidian専用から汎用的な社内ナレッジ管理ツールへ
- **UI表記**: 全ての「Vault」「Obsidian」表記を「社内ナレッジ」に統一

### 環境変数対応
- **.envファイルサポート**: APIキーを環境変数で管理可能
- **自動API設定**: 環境変数にキーがある場合、UI上でのキー入力をスキップ
- **プロバイダー自動検出**: 利用可能なAPIキーに基づいてデフォルトプロバイダーを自動選択

### セキュリティ強化
- **WebSocket CSP対応**: Content Security PolicyでWebSocket接続を許可
- **開発環境対応**: GitHub CodespacesでのWebSocket接続問題を解決

### 承認機能
- **Vault外データ使用承認**: 社内ナレッジで回答が見つからない場合の承認機能を実装
- **一般知識回答**: 承認された場合、GPT/Geminiの内蔵知識から回答を生成
- **ユーザー制御**: 外部データ使用の可否をユーザーが完全制御

### AI駆動同義語システム（革新的機能）
- **手動辞書からの脱却**: 従来の手動同義語辞書を完全廃止し、AI駆動の動的同義語生成を実装
- **リアルタイムAI同義語生成**: GPT/Geminiを活用してクエリごとに文脈適応型同義語を自動生成
- **インテリジェントキャッシング**: 30分間の賢いキャッシングシステムで高速化とコスト最適化を両立
- **三層同義語アーキテクチャ**: 
  1. **AI動的同義語生成**（メイン）: リアルタイムで文脈に応じた同義語を生成
  2. **セマンティック強化**: 複数クエリパターンの埋め込み平均で検索精度向上
  3. **適応学習システム**: ユーザー検索パターンから同義語関係を自動学習

### 検索精度とチャンク化の最適化
- **日付検索の高精度化**: 「9月5日の授業」のような日付関連ファイルの検索精度を大幅向上
- **複数日付フォーマット対応**: 「9月5日」「9/5」「2024-09-05」など様々な日付表現に対応
- **チャンク化最適化**: パラグラフ・センテンス対応の賢いチャンク化で文脈保持
- **動的しきい値調整**: 日付クエリと一般クエリで異なるしきい値を適用し最適な判定を実現

### 会話履歴管理の改善
- **独立質問処理**: 各質問を独立して処理し、過去の会話が新しい質問に誤って影響することを防止
- **フォローアップ質問識別**: 「詳しく」「なぜ」等の明確なフォローアップ語のみ会話履歴を使用
- **承認プロセス継続性**: 一度承認を拒否した後も、次回質問で正常に承認プロンプトが表示される
- **システムメッセージ除外**: 承認プロンプト等のシステムメッセージが会話履歴に影響しない設計

### Phase 1: スマート機能強化（2024年追加）
- **🎯 スマート質問候補システム**: AI駆動の質問提案機能により、ナレッジ探索を大幅に効率化
  - **4カテゴリ自動生成**: 基本・詳細・問題解決・個別化の質問を文脈に応じて自動提案
  - **信頼度スコアリング**: 各質問の回答可能性を0-100%で評価し、高品質な提案のみを表示
  - **関連文書マッピング**: 各質問に対する関連ファイル数を事前表示し、回答の深度を予測可能
  - **インテリジェントキャッシング**: 30分間のスマートキャッシュで高速表示とAPI最適化を実現
  
- **📊 ナレッジ使用状況分析**: 包括的なアナリティクスでナレッジ活用を可視化・最適化
  - **リアルタイム使用追跡**: 検索パターン、人気トピック、検索信頼度を自動記録
  - **知識ギャップ分析**: 低信頼度検索や未回答クエリから改善点を特定
  - **5次元ダッシュボード**: 概要・トピック・ギャップ・ファイル・トレンド分析を提供
  - **推奨アクション生成**: AI分析に基づく具体的な改善提案（高・中・低優先度付き）
  - **30日間データ保持**: ローカルストレージベースの永続化で使用履歴を長期保管

## 機能

-   **LLM選択可能**: Google GeminiまたはOpenAIのモデルを選択して対話できます。
-   **🎯 スマート質問候補システム** *(Phase 1)*: AI駆動の質問提案機能により、ナレッジ探索を大幅に効率化。4カテゴリ（基本・詳細・問題解決・個別化）の質問を文脈に応じて自動生成し、信頼度スコア・関連文書数・品質評価を表示。30分間のインテリジェントキャッシングで高速化とAPI最適化を実現。
-   **📊 ナレッジ使用状況分析** *(Phase 1)*: 包括的なアナリティクスでナレッジ活用を可視化・最適化。5次元ダッシュボード（概要・トピック・ギャップ・ファイル・トレンド）でリアルタイム使用追跡、知識ギャップ分析、AI推奨アクション生成を提供。30日間のローカルデータ保持で長期的な改善支援。
-   **AI駆動動的同義語システム**: 手動辞書メンテナンスを不要とする革新的なAI同義語システム。GPT/Geminiがリアルタイムで文脈に応じた同義語を生成し、30分間のインテリジェントキャッシングで高速化とコスト最適化を実現。三層アーキテクチャ（AI生成・セマンティック強化・適応学習）により、人間の言語の多様性に自動適応します。
-   **インテリジェント要約機能**: 複数ドキュメントを横断した自動要約生成システム。「要約:プロジェクト管理」「新人研修について概要」などの自然言語コマンドで、関連する全ての社内ナレッジから包括的な要約を生成。階層構造化された要約（概要→重要ポイント→関連トピック）、信頼度スコアリング、ワンクリック関連検索機能を搭載し、散在する情報の統合と知識の体系化を自動実現します。
-   **統合的スコアリング検索**: パスの一致度（ファイル名）、意味の近さ（セマンティック検索）、内容のキーワード一致度という複数の指標を統合的に評価する、高度な検索技術を採用。これにより、AIの視野を狭めることなく、複数の関連ファイルを横断して最も的確な情報を見つけ出し、検索精度を飛躍的に向上させます。
-   **Vault外データ承認機能**: 社内ナレッジで回答が見つからない場合、「Vault外の一般的な知識を使って回答しますか？」と確認し、承認されたらGPT/Geminiの内蔵知識から回答を提供します。ユーザーが完全に制御できる安全な設計です。
-   **プライバシー第一**: あなたのノートとAPIキーはブラウザ内でローカルに処理されます。サーバーにアップロードされることはなく、質問に必要な文脈のみがAIに送信されます。
-   **シンプルなインターフェース**: 直感的でクリーンなチャットインターフェースにより、スムーズな体験が可能です。
-   **Markdownサポート**: Vault内の`.md`ファイルをネイティブに理解し、処理します。

## 仕組み

1.  **AIプロバイダーの設定**: アプリケーションを開き、使用したいAIプロバイダー（GeminiまたはOpenAI）を選択し、対応するAPIキーを入力します。
2.  **Vaultの選択**: ファイルピッカーを使用して、お使いのObsidian Vaultのディレクトリを選択します。
3.  **ローカルでのベクトル化**: アプリケーションは、ブラウザ内で直接すべてのマークダウン(`.md`)ファイルを読み込み、パラグラフとセンテンスを考慮した賢い「チャンク」分割を実行。選択したAIモデルを使用して各チャンクをベクトル化（意味を数値配列に変換）し、検索可能なインデックスを作成します。
3.5. **AI同義語拡張**: 質問に対してAIがリアルタイムで同義語を生成し、検索クエリを自動拡張。「退職手続き」→「退職手続き 辞める やめる 退社手順 離職方法」のように文脈適応型で展開し、人間の言語表現の多様性に自動対応します。
4.  **統合的スコアリングの実行**: あなたが質問をすると、システムはVault内のすべての情報の断片（チャンク）一つひとつに対して、以下の要素を基に総合的な関連度スコアを計算します。
    a.  **パススコア**: 質問のキーワードがチャンクの**ファイルパス**にどれだけ含まれているか。
    b.  **セマンティックスコア**: 質問の「意味」とチャンクの内容が文脈的にどれだけ近いか。
    c.  **コンテントスコア**: 質問のキーワードがチャンクの**本文**にどれだけ含まれているか。
5.  **インテリジェントなコンテキスト生成**:
    -   算出された総合スコアに基づき、すべてのチャンクが単一のリスト上で公平にランク付けされます。
    -   スコアが最も高い、複数のファイルにまたがる可能性のある、最も関連性の高いチャンクだけを厳選し、AIへのコンテキストとして使用します。
6.  **信頼性のある回答**: AIは、提供されたコンテキストの情報に**のみ**基づいて回答するよう特別に指示されています。これにより、回答があなた自身の知識ベースから得られることが保証されます。
7.  **Vault外データ承認フロー**: 社内ナレッジで関連情報が見つからない場合（セマンティック類似度0.6未満、統合スコア0.7未満）、以下の承認プロセスが実行されます：
    -   **承認プロンプト表示**: 「Vault外の一般的な知識を使って回答しますか？」という確認メッセージを表示
    -   **承認時**: GPT/Geminiの内蔵知識を使用して回答を生成し、回答末尾に「※ この回答は社内ナレッジ以外の一般的な知識に基づいています。」を追加
    -   **拒否時**: 従来通り「提供された社内ナレッジの情報の中から、その質問に対する回答を見つけることができませんでした。」を表示
8.  **インテリジェント要約生成**: 要約リクエストが検出された場合、以下の特別処理を実行します：
    -   **自動検出**: 「要約:」「〜について要約」「〜の概要」等のパターンを自動認識
    -   **トピック横断検索**: 関連する全チャンクを選出し、統合スコアでランク付け
    -   **階層的要約生成**: AIが概要→重要ポイント→関連トピックの3層構造で要約を作成
    -   **信頼度算出**: 参照チャンク数・関連度から要約の信頼性を0-1でスコアリング
    -   **参照元追跡**: 要約に使用された全ファイルのパスを記録・表示
    -   **関連トピック提案**: AIが抽出した関連キーワードをクリック可能なボタンで表示
9.  **独立質問処理システム**: 各質問の処理において、会話履歴の適切な管理を実行します：
    -   **独立質問**: フォローアップ質問でない場合、過去の会話履歴を送信せず完全に独立して処理
    -   **フォローアップ質問**: 「詳しく」「なぜ」等の明確なフォローアップ語の場合のみ直近の会話履歴（最大3往復）を使用
    -   **システムメッセージ除外**: 承認プロンプトや拒否メッセージが会話履歴に影響しない設計
10. **回答の表示**: AIの応答がチャットインターフェースに表示されます。

## はじめに

### 前提条件

-   モダンなウェブブラウザ（例：Chrome, Firefox, Safari, Edge）。
-   Google Gemini APIキーまたはOpenAI APIキー。
    -   Gemini: [Google AI Studio](https://aistudio.google.com/app/apikey)から取得できます。
    -   OpenAI: [OpenAI Platform](https://platform.openai.com/api-keys)から取得できます。

### セットアップ

#### 開発環境での実行

1. **依存関係のインストール**:
   ```bash
   npm install
   ```

2. **環境変数の設定**（推奨）:
   プロジェクトルートに`.env`ファイルを作成し、以下のようにAPIキーを設定：
   ```bash
   # Gemini APIキー（推奨）
   GEMINI_API_KEY=your_gemini_api_key_here
   
   # または OpenAI APIキー
   # OPENAI_API_KEY=your_openai_api_key_here
   ```

3. **開発サーバーの起動**:
   ```bash
   npm run dev
   ```

4. **アプリへのアクセス**: 
   - ローカル環境: `http://localhost:5173/`
   - GitHub Codespaces: 提供されるCodespaces URLを使用

#### 本番環境での実行

1. **ビルド**:
   ```bash
   npm run build
   ```

2. **静的ファイルの配信**:
   `dist/`フォルダの内容を任意のWebサーバーで配信

#### 環境変数を使用しない場合

`.env`ファイルを設定しない場合、アプリケーション起動時にUI上でAPIキーを入力する従来の方式で利用できます。

## 使い方

### 環境変数でAPIキーを設定済みの場合
1. アプリケーションを開くと、API設定が完了している旨が表示されます
2. **「ナレッジフォルダを選択」**エリアをクリックします
3. ファイル選択ダイアログで、マークダウンファイルが格納されたフォルダを選択します
4. ファイルが処理されるのを待ちます
5. 下部の入力ボックスに質問を入力し、`Enter`キーを押すか**「送信」**ボタンをクリックします
6. **🎯 スマート質問候補** *(Phase 1)*: 検索後に関連する質問候補が自動表示されます
   - **4つのカテゴリ**: 基本・詳細・問題解決・個別化の質問を文脈に応じて提案
   - **信頼度表示**: 各質問の回答可能性を0-100%で評価
   - **関連文書数**: 質問に関連するファイル数を事前表示
   - **ワンクリック検索**: 質問をクリックすると自動的に検索を実行
7. **📊 分析ダッシュボード** *(Phase 1)*: ヘッダーのチャートアイコンから分析画面にアクセス
   - **概要**: 総検索数、平均信頼度、人気トピックのクイック統計
   - **トピック分析**: 最も検索されているトピックと検索頻度
   - **知識ギャップ**: 低信頼度検索から改善すべき領域を特定
   - **ファイル使用状況**: どのファイルが最も活用されているかを可視化
   - **トレンド分析**: 時系列での検索パターンと傾向を表示
8. **インテリジェント要約機能**: 以下のコマンドで包括的な要約が生成されます
   - **「要約: プロジェクト管理」**: 指定トピックの要約を生成
   - **「新人研修について概要」**: 自然言語での要約リクエスト
   - **「退職手続きの総括」**: まとめ・総括での要約指示
   - 要約結果は階層構造（概要→重要ポイント→関連トピック）で表示
   - 信頼度スコア・参照元ファイル・関連トピックも同時に提示
9. **承認機能**: 社内ナレッジで回答が見つからない場合、承認プロンプトが表示されます
   - **「はい、一般知識を使用」**: GPT/Geminiの内蔵知識から回答を生成
   - **「いいえ」**: 「見つかりませんでした」メッセージを表示

### 環境変数を使用しない場合
1. アプリケーションを開き、まず**AIプロバイダーを選択**し、あなたの**APIキーを入力**します
2. **「ナレッジフォルダを選択」**エリアをクリックします
3. ファイル選択ダイアログで、マークダウンファイルが格納されたフォルダを選択します
4. ファイルが処理されるのを待ちます。チャットウィンドウの上部に、読み込まれたファイル数を示す確認メッセージが表示されます
5. 下部の入力ボックスに質問を入力し、`Enter`キーを押すか**「送信」**ボタンをクリックします
6. **インテリジェント要約機能**: 要約コマンドで複数ファイルを横断した包括的要約を生成
   - **「要約: 〜」**形式または**「〜について要約」**形式で入力
   - 関連する全チャンクから階層構造化された要約を自動作成
   - 信頼度・参照元・関連トピックを含む詳細情報も提供
7. **承認機能**: 社内ナレッジで回答が見つからない場合、承認プロンプトが表示されます
   - **「はい、一般知識を使用」**: GPT/Geminiの内蔵知識から回答を生成
   - **「いいえ」**: 「見つかりませんでした」メッセージを表示

### 承認機能の詳細

#### 動作条件
承認プロンプトが表示されるのは以下の場合です：
- **一般クエリ**: セマンティック類似度が0.7未満、統合スコアが0.8未満
- **日付クエリ**: セマンティック類似度が0.3未満、統合スコアが0.4未満（日付検索精度優先）

#### 継続性の確保
- **承認拒否後の動作**: 一度承認を拒否しても、次回の質問では再度承認プロンプトが正常に表示されます
- **独立質問処理**: 各質問が完全に独立して処理されるため、過去の承認履歴に影響されません
- **会話履歴の適切な管理**: システムメッセージや承認拒否メッセージがAIの判断に影響しません

#### テスト方法

**承認機能のテスト**
Vault内に存在しない情報について質問してください：
- 「今日の天気は？」
- 「ChatGPTについて教えて」  
- 「大統領の名前は？」→ 拒否 → 「今日のニュースは？」（継続テスト）
- 「一般的なプログラミング言語の特徴」

**インテリジェント要約機能のテスト**
以下のコマンドで要約機能をテストできます：
- **「要約: プロジェクト管理」**: 複数ファイルから統合要約を生成
- **「新人研修について概要」**: 自然言語での要約リクエスト
- **「会議運営方法の総括」**: まとめ・総括キーワードでの要約
- **「まとめ: マーケティング戦略」**: 別のまとめ表現での要約

**日付検索のテスト**
日付関連ファイルの検索精度をテストするには：
- 「9月5日の授業内容は？」（9月5日授業.mdファイルが存在する場合）
- 「2024/09/10の会議について」
- 「12-25のイベント詳細」

## 技術スタック

-   **フロントエンド**: React 19+, TypeScript, Tailwind CSS
-   **ビルドツール**: Vite（高速HMR）
-   **AI技術**: 
    - Google Gemini API (`@google/genai`) - 同義語生成・検索・要約・質問候補生成
    - OpenAI API (`openai`) - GPT-4による高精度同義語生成・要約・質問候補生成
    - ベクトル埋め込み検索（コサイン類似度）
-   **同義語システム**: AI駆動三層アーキテクチャ
    - `dynamicSynonymService.ts`: リアルタイムAI同義語生成（30分キャッシュ）
    - `semanticEnhancementService.ts`: クエリパターン拡張・埋め込み平均
    - `adaptiveSynonymService.ts`: 学習型同義語関係構築
-   **要約システム**: インテリジェント要約生成エンジン
    - `summaryService.ts`: AI駆動トピック横断要約生成・階層構造化
    - `SummaryDisplay.tsx`: 信頼度可視化・関連トピック提案UI
    - 統合スコアリング・参照元追跡・関連性算出
-   **Phase 1 スマート機能**: 
    - `questionSuggestionService.ts`: AI駆動4カテゴリ質問候補生成（30分キャッシュ）
    - `QuestionSuggestions.tsx`: 展開可能カテゴリ・信頼度・品質表示UI
    - `analyticsService.ts`: リアルタイム使用追跡・知識ギャップ分析
    - `AnalyticsDashboard.tsx`: 5次元分析（概要・トピック・ギャップ・ファイル・トレンド）
    - ローカルストレージ永続化・30日データ保持・推奨アクション生成
-   **モジュールシステム**: `esm.sh`を介したブラウザ内ESモジュール
-   **開発環境**: GitHub Codespaces対応、WSL2最適化

## AI同義語システムのテスト方法

### 同義語生成のテスト
以下のクエリで同義語システムの動作を確認できます：

**ビジネス用語**:
- 「退職手続きについて」→ AI生成: 退職、辞める、離職手順など
- 「会議の準備方法」→ AI生成: 打ち合わせ、ミーティング、準備手順など
- 「新人研修の内容」→ AI生成: 新入社員、教育、トレーニングなど

**学習関連**:
- 「プログラミング学習法」→ AI生成: 習得、勉強、プログラム開発など
- 「資格取得の手順」→ AI生成: 取る、習得、認定など

### 同義語キャッシュの確認
ブラウザの開発者ツールで以下を実行:
```javascript
// キャッシュ統計表示
console.log(window.getSynonymCacheStats());

// キャッシュクリア
window.clearSynonymCache();
```

### パフォーマンス最適化
- **キャッシュヒット率**: 初回30分は同義語生成、その後はキャッシュから高速取得
- **コスト効率**: 重複する同義語リクエストを自動的にキャッシュで処理
- **フォールバック**: AI同義語生成失敗時は元クエリで正常動作

## トラブルシューティング

### Windows WSL（Windows Subsystem for Linux）での使用

#### 前提条件
- Windows 10 バージョン 2004 以降、または Windows 11
- WSL2 がインストールされていること
- Ubuntu、Debian などの Linux ディストリビューション
- Node.js v18+ と npm がWSL内にインストールされていること

#### セットアップ手順
1. **WSL環境でのクローン**:
   ```bash
   # WSL内で実行
   cd ~
   git clone https://github.com/CatwalkTK/Obsidiansearch.git
   cd Obsidiansearch
   ```

2. **依存関係のインストール**:
   ```bash
   npm install
   ```

3. **環境変数の設定**:
   ```bash
   # .envファイルを作成
   nano .env
   # 以下を追加
   GEMINI_API_KEY=your_gemini_api_key_here
   ```

4. **開発サーバーの起動**:
   ```bash
   # WSL内のホストバインディング
   npm run dev -- --host 0.0.0.0
   ```

#### WSL特有の注意点

**ポートアクセス**:
- Windowsブラウザからは `http://localhost:5173/` でアクセス可能
- WSL2の場合、自動的にポート転送が設定されます
- 接続できない場合は Windows PowerShell で以下を実行:
  ```powershell
  netsh interface portproxy add v4tov4 listenport=5173 listenaddress=0.0.0.0 connectport=5173 connectaddress=(wsl hostname -I)
  ```

**ファイルシステムアクセス**:
- Markdownファイルは Windows ファイルシステム (`/mnt/c/Users/...`) に配置可能
- WSL ファイルシステム (`/home/...`) からもアクセス可能
- ファイル選択時は WSL から Windows のファイルも選択できます

**パフォーマンス最適化**:
- プロジェクトファイルは WSL ファイルシステム内に配置することを推奨
- Windows ファイルシステムからの実行は若干パフォーマンスが低下する場合があります

**ファイアウォール設定**:
```powershell
# Windows Defender ファイアウォールで Node.js を許可
# Windows Security > Firewall & network protection > Allow an app through firewall
# Node.js を追加し、プライベート・パブリック両方をチェック
```

### GitHub Codespacesでの使用
- `localhost:5173`ではなく、Codespacesが提供するURL（例：`https://xxx-5173.app.github.dev/`）を使用してください
- ポート転送の設定を確認し、必要に応じて公開設定を変更してください

### AI同義語システムのトラブル

**同義語が生成されない場合**:
1. APIキーが正しく設定されているか確認
2. ネットワーク接続状況を確認
3. ブラウザコンソールでエラーログをチェック
4. キャッシュをクリアして再試行

**同義語の品質が低い場合**:
- AI同義語は文脈に応じて動的生成されるため、具体的で明確なキーワードを含む質問が効果的
- 短すぎるクエリ（2文字未満）や記号のみは自動的にスキップされます

**パフォーマンス問題**:
- キャッシュ統計を確認し、ヒット率が低い場合はクエリの多様性を見直し
- APIレート制限に達している可能性がある場合は時間をおいて再試行

### HTTP 401エラーが発生する場合
1. 環境変数に正しいAPIキーが設定されているか確認
2. 開発サーバーを再起動（`npm run dev`）
3. ブラウザのキャッシュをクリア
4. AI同義語機能使用時は適切なAPIキー（GeminiまたはOpenAI）が必要

### WebSocket接続エラーが発生する場合
- Content Security Policy (CSP) の設定により、適切なWebSocket接続が許可されています
- 開発サーバーの再起動で解決する場合があります